function [f, fdx, fdxp,fdp] = Hammond_4blade(t, x, xp,Omega)
% Data
Nb = 4;
e  =    0.3048; % m
R  =     7.620; % m
Mb =      94.9; % Kg
Sb =     289.1; % Kg*m
Ib =    1084.7; % Kg*m^2
Cb =    4067.5; % N*m*s/rad
Kb =       0.0; % N*m/rad
nu2=   e*Sb/Ib;

Mx =    8026.6; % Kg
Cx =   51078.7; % N*s/m
Kx = 1240481.8; % N/m

My =    3283.6; % Kg
Cy =   25539.3; % N*s/m
Ky = 1240481.8; % N/m

psi1=Omega*t;
psi2=pi/2+Omega*t;
psi3=pi+Omega*t;
psi4=3/2*pi+Omega*t;

% Spring x
x1=x(1);
x2=x(2);
xp1=xp(1);
xp2=xp(2);
% Spring y
y1=x(3);
y2=x(4);
yp1=xp(3);
yp2=xp(4);
% Blade 1
z1=x(5);
z2=x(6);
zp1=xp(5);
zp2=xp(6);
% Blade 2
z21=x(7);
z22=x(8);
z2p1=xp(7);
z2p2=xp(8);
% Blade 3
z31=x(9);
z32=x(10);
z3p1=xp(9);
z3p2=xp(10);
% Blade 4
z41=x(11);
z42=x(12);
z4p1=xp(11);
z4p2=xp(12);
% stability
i=0;  % if i==1 stable, if i ==0 unstable
j=1;
k=1;
% e=e/rho <================= testare
% Noise : 1*normrnd(0,1)*sqrt(1e-2)
r=(Mb/Sb);
% f(x',x,t)=0
f=[xp1-x2;yp1-y2;zp1-z2;z2p1-z22;z3p1-z32;z4p1-z42;...
    (Mx+Nb*Mb)*xp2+Cx*x2+Kx*x1-Sb*(zp2*sin(psi1+z1)+(Omega+z2)^2*cos(psi1+z1)+r*e*(Omega^2)*cos(psi1)+...    % Equilibrium x direction
    z2p2*sin(psi2+z21)+(Omega+z22)^2*cos(psi2+z21)+r*e*(Omega^2)*cos(psi2)+...
    z3p2*sin(psi3+z31)+(Omega+z32)^2*cos(psi3+z31)+r*e*(Omega^2)*cos(psi3)+...
    z4p2*sin(psi4+z41)+(Omega+z42)^2*cos(psi4+z41)+r*e*(Omega^2)*cos(psi4));...
    (My+Nb*Mb)*yp2+Cy*y2+Ky*y1+Sb*(zp2*cos(psi1+z1)-(Omega+z2)^2*sin(psi1+z1)-r*e*(Omega^2)*sin(psi1)+...    % Equilibrium y direction
    z2p2*cos(psi2+z21)-(Omega+z22)^2*sin(psi2+z21)-r*e*(Omega^2)*sin(psi2)+...
    z3p2*cos(psi3+z31)-(Omega+z32)^2*sin(psi3+z31)-r*e*(Omega^2)*sin(psi3)+...
    z4p2*cos(psi4+z41)-(Omega+z42)^2*sin(psi4+z41)-r*e*(Omega^2)*sin(psi4));
    Ib*zp2+Cb*z2+Kb*z1+Sb*e*Omega^2*sin(z1)-Sb*(xp2*sin(psi1+z1)-yp2*cos(psi1+z1));...           % Blade 1
    Ib*z2p2+j*Cb*z22+Kb*z21+Sb*e*Omega^2*sin(z21)-Sb*(xp2*sin(psi2+z21)-yp2*cos(psi2+z21));...     % Blade 2
    Ib*z3p2+i*Cb*z32+Kb*z31+Sb*e*Omega^2*sin(z31)-Sb*(xp2*sin(psi3+z31)-yp2*cos(psi3+z31));...     % Blade 3
    Ib*z4p2+Cb*k*z42+Kb*z41+Sb*e*Omega^2*sin(z41)-Sb*(xp2*sin(psi4+z41)-yp2*cos(psi4+z41));];      % Blade 4





fdp = [0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,...
    0,0,...
    0,0,...
    0,0;...
    0,0,0,0,0,0,...
    0,0,...
    0,0,...
    0,0;...
    0,0,0,0,0,1,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,1,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,1,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,1;];


% fdp = [0,0,0,0,0,0,0,0,0,0,0,0;... % sensibilty Omega ?
%     0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,-Sb*(-zp2*t*sin(psi1+z1)-2*(Omega+z2)*sin(psi1+z1)-(Omega+z2)^2*t*cos(psi1+z1)),-2*Sb*cos(psi1+z1)+2*Sb*(Omega+z2)*t*sin(psi1+z1),...
%     -Sb*(-z2p2*t*sin(psi2+z21)-2*(Omega+z22)*sin(psi2+z21)-(Omega+z22)^2*t*cos(psi2+z21)),-2*Sb*cos(psi2+z21)+2*Sb*(Omega+z22)*t*sin(psi2+z21),...
%     -Sb*(-z3p2*t*sin(psi3+z31)-2*(Omega+z32)*sin(psi3+z31)-(Omega+z32)^2*t*cos(psi3+z31)),-2*Sb*cos(psi3+z31)+2*Sb*(Omega+z32)*t*sin(psi3+z31),...
%     -Sb*(-z4p2*t*sin(psi4+z41)-2*(Omega+z42)*sin(psi4+z41)-(Omega+z42)^2*t*cos(psi4+z41)),-2*Sb*cos(psi4+z41)+2*Sb*(Omega+z42)*t*sin(psi4+z41);...
%     0,0,0,0,+Sb*(-zp2*t*cos(psi1+z1)-2*(Omega+z2)*cos(psi1+z1)+(Omega+z2)^2*t*sin(psi1+z1)),-2*Sb*sin(psi1+z1)-2*Sb*(Omega+z2)*t*cos(psi1+z1),...
%     +Sb*(-z2p2*t*cos(psi2+z21)-2*(Omega+z22)*cos(psi2+z21)+(Omega+z22)^2*t*sin(psi2+z21)),-2*Sb*sin(psi2+z21)-2*Sb*(Omega+z22)*t*cos(psi2+z21),...
%     +Sb*(-z3p2*t*cos(psi3+z31)-2*(Omega+z32)*cos(psi3+z31)+(Omega+z32)^2*t*sin(psi3+z31)),-2*Sb*sin(psi3+z31)-2*Sb*(Omega+z32)*t*cos(psi3+z31),...
%     +Sb*(-z4p2*t*cos(psi4+z41)-2*(Omega+z42)*cos(psi4+z41)+(Omega+z42)^2*t*sin(psi4+z41)),-2*Sb*sin(psi4+z41)-2*Sb*(Omega+z42)*t*cos(psi4+z41);...
%     0,0,0,0,2*Sb*e*Omega*cos(z1)-Sb*(-xp2*t*sin(psi1+z1)+yp2*t*cos(psi1+z1)),0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,2*Sb*e*Omega*cos(z21)-Sb*(-xp2*t*sin(psi2+z21)+yp2*t*cos(psi2+z21)),0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,2*Sb*e*Omega*cos(z31)-Sb*(-xp2*t*sin(psi3+z31)+yp2*t*cos(psi3+z31)),0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,2*Sb*e*Omega*cos(z41)-Sb*(-xp2*t*sin(psi4+z41)+yp2*t*cos(psi4+z41)),0;];

% Jacobian matrix of x
fdx = [0,-1,0,0,0,0,0,0,0,0,0,0;...
    0,0,0,-1,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,-1,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,-1,0,0,0,0;...
    0,0,0,0,0,0,0,0,0,-1,0,0;...
    0,0,0,0,0,0,0,0,0,0,0,-1;...
    Kx,Cx,0,0,-Sb*(zp2*cos(psi1+z1)-(Omega+z2)^2*sin(psi1+z1)),-2*Sb*(Omega+z2)*cos(psi1+z1),...
    -Sb*(z2p2*cos(psi2+z21)-(Omega+z22)^2*sin(psi2+z21)),-2*Sb*(Omega+z22)*cos(psi2+z21),...
    -Sb*(z3p2*cos(psi3+z31)-(Omega+z32)^2*sin(psi3+z31)),-2*Sb*(Omega+z32)*cos(psi3+z31),...
    -Sb*(z4p2*cos(psi4+z41)-(Omega+z42)^2*sin(psi4+z41)),-2*Sb*(Omega+z42)*cos(psi4+z41);...
    0,0,Ky,Cy,+Sb*(-zp2*sin(psi1+z1)-(Omega+z2)^2*cos(psi1+z1)),-2*Sb*(Omega+z2)*sin(psi1+z1),...
    +Sb*(-z2p2*sin(psi2+z21)-(Omega+z22)^2*cos(psi2+z21)),-2*Sb*(Omega+z22)*sin(psi2+z21),...
    +Sb*(-z3p2*sin(psi3+z31)-(Omega+z32)^2*cos(psi3+z31)),-2*Sb*(Omega+z32)*sin(psi3+z31),...
    +Sb*(-z4p2*sin(psi4+z41)-(Omega+z42)^2*cos(psi4+z41)),-2*Sb*(Omega+z42)*sin(psi4+z41);...
    0,0,0,0,Kb+Sb*e*Omega^2*cos(z1)-Sb*(xp2*cos(psi1+z1)+yp2*sin(psi1+z1)),Cb,0,0,0,0,0,0;...
    0,0,0,0,0,0,Kb+Sb*e*Omega^2*cos(z21)-Sb*(xp2*cos(psi2+z21)+yp2*sin(psi2+z21)),Cb*j,0,0,0,0;...
    0,0,0,0,0,0,0,0,Kb+Sb*e*Omega^2*cos(z31)-Sb*(xp2*cos(psi3+z31)+yp2*sin(psi3+z31)),Cb*i,0,0;...
    0,0,0,0,0,0,0,0,0,0,Kb+Sb*e*Omega^2*cos(z41)-Sb*(xp2*cos(psi4+z41)+yp2*sin(psi4+z41)),Cb*k;];
% Jacobian matrix of x'
fdxp = [1,0,0,0,0,0,0,0,0,0,0,0;...
    0,0,1,0,0,0,0,0,0,0,0,0;...
    0,0,0,0,1,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,1,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,1,0,0,0;...
    0,0,0,0,0,0,0,0,0,0,1,0;...
    0,(Mx+Nb*Mb),0,0,0,-Sb*sin(psi1+z1),0,-Sb*sin(psi2+z21),0,-Sb*sin(psi3+z31),0,-Sb*sin(psi4+z41);...
    0,0,0,(My+Nb*Mb),0,Sb*cos(psi1+z1),0,Sb*cos(psi2+z21),0,Sb*cos(psi3+z31),0,Sb*cos(psi4+z41);...
    0,-Sb*sin(psi1+z1),0,Sb*cos(psi1+z1),0,Ib,0,0,0,0,0,0;...
    0,-Sb*sin(psi2+z21),0,Sb*cos(psi2+z21),0,0,0,Ib,0,0,0,0;...
    0,-Sb*sin(psi3+z31),0,Sb*cos(psi3+z31),0,0,0,0,0,Ib,0,0;...
    0,-Sb*sin(psi4+z41),0,Sb*cos(psi4+z41),0,0,0,0,0,0,0,Ib;];




end

